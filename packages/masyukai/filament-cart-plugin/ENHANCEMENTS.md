# Cart Plugin Enhancement Features

This document describes the new advanced filtering and condition management features added to the masyukai/filament-cart-plugin.

## Overview

The enhanced cart plugin now supports:

1. **Advanced Search & Filters** - Find carts by items, conditions, computed states
2. **Condition Management** - Create and manage static/dynamic conditions  
3. **Global Conditions** - Apply conditions across all carts automatically
4. **Item-Level Conditions** - Apply conditions to specific cart items
5. **Built-in Collection Filtering** - Leverage core cart package filtering methods

## New Features

### 1. Advanced Cart Filtering

The cart list now includes powerful filtering options with **two approaches**:

#### Database-Level Filtering (for Filament tables and large datasets)
- **Performance Optimized**: Uses MySQL JSON functions for efficient querying
- **Scalable**: Works with large cart datasets without loading all data into memory
- **Filament Integration**: Powers the table filters in the admin interface

#### Collection-Level Filtering (for runtime manipulation)
- **Feature Rich**: Leverages built-in collection methods from the core cart package
- **In-Memory**: Works with loaded cart data for immediate manipulation
- **Type Safe**: Uses strongly typed CartItem and CartCollection objects

#### Cart Item Filters
- **Product Search**: Find carts containing specific product IDs
- **Item Count**: Filter carts by exact item count or use operators (>, <, >=, <=)
- **Subtotal Range**: Filter carts by subtotal amount range

#### Condition-Based Filters  
- **Condition Name**: Search carts by condition names applied
- **Condition Type**: Filter by static vs. dynamic conditions
- **Condition Value**: Search by specific condition values
- **Has Conditions**: Filter carts with or without any conditions

#### Computed State Filters
- **Total Weight**: View and sort by total cart weight
- **Formatted Total**: See final totals with conditions applied
- **Recent Activity**: Filter by cart activity timeframes

### 2. Condition Management

A complete CRUD interface for managing cart conditions:

#### Condition Types
- **Static Conditions**: Manually defined rules (discounts, fees, etc.)
- **Dynamic Conditions**: Auto-generated by the cart system

#### Condition Targets
- **Item Level**: Applied to individual cart items
- **Subtotal**: Applied to cart subtotal before other calculations
- **Total**: Applied to final cart total

#### Condition Values
Supports various operators:
- `+10` - Add fixed amount
- `-15` - Subtract fixed amount  
- `+5%` - Add percentage
- `-10%` - Subtract percentage
- `*1.5` - Multiply by factor
- `/2` - Divide by factor

### 3. Cart Actions

New actions available on cart records:

#### Add Condition
- Select from existing conditions
- Apply to entire cart or specific items
- Immediate application with timestamp tracking

#### Condition Management
- View applied conditions on each cart
- Remove or modify existing conditions
- Track condition application history

## Usage Examples

### Database-Level Filtering (for large datasets and Filament)

```php
use MasyukAI\FilamentCartPlugin\Models\Cart;

// Find carts with specific products (database query)
$carts = Cart::withProduct('product-123')->get();

// Find carts with more than 3 items (database query)
$carts = Cart::withItemCount(3, '>')->get();

// Find carts in price range (database query)
$carts = Cart::withSubtotalBetween(100, 500)->get();

// Find carts with specific conditions (database query)
$carts = Cart::withCondition('holiday-discount')->get();

// Find carts with dynamic conditions (database query)
$carts = Cart::withDynamicConditions()->get();
```

### Collection-Level Filtering (for runtime manipulation)

```php
use MasyukAI\FilamentCartPlugin\Models\Cart;

$cart = Cart::find(1);

// Get cart items as a strongly-typed collection
$itemsCollection = $cart->getItemsCollection();

// Filter items using built-in collection methods
$discountItems = $cart->getItemsByConditionType('discount');
$subtotalItems = $cart->getItemsByConditionTarget('subtotal');
$specialItems = $cart->getItemsByCondition('holiday-special');
$percentageItems = $cart->getItemsByConditionValue('10%');

// Chain collection methods for complex filtering
$complexFiltered = $cart->getItemsCollection()
    ->filterByConditionType('discount')
    ->filterByConditionTarget('subtotal')
    ->filter(fn($item) => $item->getPrice() > 50);
```

### When to Use Each Approach

**Use Database-Level Filtering when:**
- Working with large datasets (1000+ carts)
- Building Filament table filters
- Need to paginate results
- Want to minimize memory usage

**Use Collection-Level Filtering when:**
- Working with individual loaded carts
- Need complex, multi-step filtering logic
- Want to leverage built-in cart package features
- Need type safety and IDE support

### Creating Conditions

```php
use MasyukAI\FilamentCartPlugin\Models\CartCondition;

// Create a discount condition
CartCondition::create([
    'name' => 'holiday-discount',
    'type' => 'static',
    'target' => 'subtotal', 
    'value' => '-20%',
    'is_global' => true,
    'is_active' => true,
    'description' => '20% holiday discount for all customers'
]);

// Create a shipping fee
CartCondition::create([
    'name' => 'express-shipping',
    'type' => 'static',
    'target' => 'total',
    'value' => '+25',
    'is_global' => false,
    'description' => 'Express shipping upgrade fee'
]);
```

### Cart Computed Properties

```php
$cart = Cart::find(1);

// Get computed properties
$itemCount = $cart->items_count;        // Number of unique items
$totalQuantity = $cart->total_quantity; // Sum of all quantities  
$totalWeight = $cart->total_weight;     // Total weight in kg
$subtotal = $cart->subtotal;            // Subtotal before conditions
$total = $cart->total;                  // Final total with conditions
$productIds = $cart->product_ids;       // Array of product IDs
$conditionNames = $cart->condition_names; // Array of applied condition names

// Check cart contents
$hasProduct = $cart->hasProduct('product-123');
$hasAnyProduct = $cart->hasAnyProduct(['product-123', 'product-456']);
$hasCondition = $cart->hasCondition('holiday-discount');
```

## Database Schema

### cart_conditions Table

```sql
CREATE TABLE cart_conditions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    type ENUM('static', 'dynamic') DEFAULT 'static',
    target ENUM('item', 'subtotal', 'total') DEFAULT 'subtotal', 
    value VARCHAR(255) NOT NULL,
    attributes JSON NULL,
    order INT DEFAULT 0,
    is_global BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    description TEXT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    INDEX idx_type_active (type, is_active),
    INDEX idx_target_active (target, is_active),
    INDEX idx_global_active (is_global, is_active)
);
```

### Enhanced carts Table Usage

The existing `carts` table JSON columns now support enhanced querying:

- `items` - Product data with attributes including weight
- `conditions` - Applied condition history with timestamps
- `metadata` - Additional cart context and customer information

## Migration Guide

### Running Migrations

```bash
php artisan migrate
```

### Seeding Sample Data

```bash
php artisan db:seed --class=MasyukAI\\FilamentCartPlugin\\Database\\Seeders\\CartPluginSeeder
```

### Updating Existing Code

The enhancement is backward compatible. Existing cart functionality continues to work unchanged.

To leverage new features in existing code:

1. Update cart filtering queries to use new scopes
2. Add condition management to cart workflows  
3. Utilize computed properties for enhanced cart displays
4. Implement condition-based business logic

## Testing

Run the test suite to verify functionality:

```bash
php artisan test packages/masyukai/filament-cart-plugin/tests/Feature/CartFiltersTest.php
```

The test suite covers:
- Cart filtering by item count, products, subtotal range
- Condition management and validation
- Cart computed property calculations
- Condition application and removal

## Performance Considerations

### Database-Level Filtering
- JSON column queries use MySQL JSON functions for optimal performance
- Indexes are added on frequently filtered condition columns
- Suitable for large datasets without memory overhead
- Integrates seamlessly with Laravel's query builder and pagination

### Collection-Level Filtering  
- Uses built-in cart package collection methods for type safety
- Requires loading cart data into memory first
- Optimal for runtime manipulation of individual carts
- Leverages cached computed properties to avoid recalculation

### Recommendations
- Use database-level filtering for Filament admin interfaces and reports
- Use collection-level filtering for application logic and cart manipulation
- Consider hybrid approaches: database filtering for initial queries, collection filtering for detailed processing

## Security Notes

- All condition values are validated for safe operators
- User input is sanitized before JSON queries
- Condition application is logged with timestamps
- Global conditions require appropriate permissions to modify