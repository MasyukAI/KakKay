# Cart Plugin Enhancement Features

This document describes the new advanced filtering and condition management features added to the masyukai/filament-cart-plugin.

## Overview

The enhanced cart plugin now supports:

1. **Advanced Search & Filters** - Find carts by items, conditions, computed states
2. **Condition Management** - Create and manage static/dynamic conditions  
3. **Global Conditions** - Apply conditions across all carts automatically
4. **Item-Level Conditions** - Apply conditions to specific cart items

## New Features

### 1. Advanced Cart Filtering

The cart list now includes powerful filtering options:

#### Cart Item Filters
- **Product Search**: Find carts containing specific product IDs
- **Item Count**: Filter carts by exact item count or use operators (>, <, >=, <=)
- **Subtotal Range**: Filter carts by subtotal amount range

#### Condition-Based Filters  
- **Condition Name**: Search carts by condition names applied
- **Condition Type**: Filter by static vs. dynamic conditions
- **Condition Value**: Search by specific condition values
- **Has Conditions**: Filter carts with or without any conditions

#### Computed State Filters
- **Total Weight**: View and sort by total cart weight
- **Formatted Total**: See final totals with conditions applied
- **Recent Activity**: Filter by cart activity timeframes

### 2. Condition Management

A complete CRUD interface for managing cart conditions:

#### Condition Types
- **Static Conditions**: Manually defined rules (discounts, fees, etc.)
- **Dynamic Conditions**: Auto-generated by the cart system

#### Condition Targets
- **Item Level**: Applied to individual cart items
- **Subtotal**: Applied to cart subtotal before other calculations
- **Total**: Applied to final cart total

#### Condition Values
Supports various operators:
- `+10` - Add fixed amount
- `-15` - Subtract fixed amount  
- `+5%` - Add percentage
- `-10%` - Subtract percentage
- `*1.5` - Multiply by factor
- `/2` - Divide by factor

### 3. Cart Actions

New actions available on cart records:

#### Add Condition
- Select from existing conditions
- Apply to entire cart or specific items
- Immediate application with timestamp tracking

#### Condition Management
- View applied conditions on each cart
- Remove or modify existing conditions
- Track condition application history

## Usage Examples

### Creating Conditions

```php
use MasyukAI\FilamentCartPlugin\Models\CartCondition;

// Create a discount condition
CartCondition::create([
    'name' => 'holiday-discount',
    'type' => 'static',
    'target' => 'subtotal', 
    'value' => '-20%',
    'is_global' => true,
    'is_active' => true,
    'description' => '20% holiday discount for all customers'
]);

// Create a shipping fee
CartCondition::create([
    'name' => 'express-shipping',
    'type' => 'static',
    'target' => 'total',
    'value' => '+25',
    'is_global' => false,
    'description' => 'Express shipping upgrade fee'
]);
```

### Filtering Carts

```php
use MasyukAI\FilamentCartPlugin\Models\Cart;

// Find carts with specific products
$carts = Cart::withProduct('product-123')->get();

// Find carts with more than 3 items
$carts = Cart::withItemCount(3, '>')->get();

// Find carts in price range
$carts = Cart::withSubtotalBetween(100, 500)->get();

// Find carts with specific conditions
$carts = Cart::withCondition('holiday-discount')->get();

// Find carts with dynamic conditions
$carts = Cart::withDynamicConditions()->get();
```

### Cart Computed Properties

```php
$cart = Cart::find(1);

// Get computed properties
$itemCount = $cart->items_count;        // Number of unique items
$totalQuantity = $cart->total_quantity; // Sum of all quantities  
$totalWeight = $cart->total_weight;     // Total weight in kg
$subtotal = $cart->subtotal;            // Subtotal before conditions
$total = $cart->total;                  // Final total with conditions
$productIds = $cart->product_ids;       // Array of product IDs
$conditionNames = $cart->condition_names; // Array of applied condition names

// Check cart contents
$hasProduct = $cart->hasProduct('product-123');
$hasAnyProduct = $cart->hasAnyProduct(['product-123', 'product-456']);
$hasCondition = $cart->hasCondition('holiday-discount');
```

## Database Schema

### cart_conditions Table

```sql
CREATE TABLE cart_conditions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    type ENUM('static', 'dynamic') DEFAULT 'static',
    target ENUM('item', 'subtotal', 'total') DEFAULT 'subtotal', 
    value VARCHAR(255) NOT NULL,
    attributes JSON NULL,
    order INT DEFAULT 0,
    is_global BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    description TEXT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    INDEX idx_type_active (type, is_active),
    INDEX idx_target_active (target, is_active),
    INDEX idx_global_active (is_global, is_active)
);
```

### Enhanced carts Table Usage

The existing `carts` table JSON columns now support enhanced querying:

- `items` - Product data with attributes including weight
- `conditions` - Applied condition history with timestamps
- `metadata` - Additional cart context and customer information

## Migration Guide

### Running Migrations

```bash
php artisan migrate
```

### Seeding Sample Data

```bash
php artisan db:seed --class=MasyukAI\\FilamentCartPlugin\\Database\\Seeders\\CartPluginSeeder
```

### Updating Existing Code

The enhancement is backward compatible. Existing cart functionality continues to work unchanged.

To leverage new features in existing code:

1. Update cart filtering queries to use new scopes
2. Add condition management to cart workflows  
3. Utilize computed properties for enhanced cart displays
4. Implement condition-based business logic

## Testing

Run the test suite to verify functionality:

```bash
php artisan test packages/masyukai/filament-cart-plugin/tests/Feature/CartFiltersTest.php
```

The test suite covers:
- Cart filtering by item count, products, subtotal range
- Condition management and validation
- Cart computed property calculations
- Condition application and removal

## Performance Considerations

- JSON column queries use MySQL JSON functions for optimal performance
- Indexes are added on frequently filtered condition columns
- Computed properties are cached as attributes to avoid recalculation
- Large cart datasets should consider database-level optimizations

## Security Notes

- All condition values are validated for safe operators
- User input is sanitized before JSON queries
- Condition application is logged with timestamps
- Global conditions require appropriate permissions to modify