# Payment Flow: Visual Diagram

## Complete Flow Visualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CHECKOUT PHASE                                   â”‚
â”‚                     (Bayar Sekarang Clicked)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer   â”‚  Fills checkout form
â”‚   Browser   â”‚  Clicks "Bayar Sekarang"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /checkout
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Checkout Component â”‚  submitCheckout()
â”‚  (Livewire)        â”‚  Validates form data
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ processCheckout($customerData)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CheckoutService    â”‚  Main orchestrator
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ createPaymentIntent($cart, $customerData)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PaymentService     â”‚  Handles CHIP API
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. POST to CHIP API
         â”‚    /purchases/
         â”‚    {
         â”‚      "client": {"email": "..."},
         â”‚      "purchase": {"products": [...]}
         â”‚    }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHIP Gateway     â”‚  Creates purchase
â”‚                    â”‚  Returns purchase_id & checkout_url
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Response: {
         â”‚   "id": "pur_abc123",
         â”‚   "checkout_url": "https://gate.chip-in.asia/..."
         â”‚ }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PaymentService     â”‚  Stores in cart metadata
â”‚                    â”‚
â”‚ cart.setMetadata('payment_intent', {
â”‚   purchase_id: "pur_abc123",
â”‚   amount: 15000,
â”‚   cart_snapshot: [...],      â† FULL CART STATE
â”‚   customer_data: {...},      â† FORM DATA
â”‚   status: "created",
â”‚   checkout_url: "https://...",
â”‚   created_at: "2025-10-06T10:30:00Z",
â”‚   expires_at: "2025-10-06T11:00:00Z"
â”‚ })
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Database Write
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CARTS TABLE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: uuid                                                    â”‚
â”‚ identifier: "session_abc123"                                â”‚
â”‚ instance: "default"                                         â”‚
â”‚ items: {...}                                                â”‚
â”‚ conditions: {...}                                           â”‚
â”‚ metadata: {                                                 â”‚
â”‚   "payment_intent": {          â† ONLY THIS UPDATED         â”‚
â”‚     "purchase_id": "pur_abc123",                            â”‚
â”‚     "amount": 15000,                                        â”‚
â”‚     "cart_snapshot": [{...}],                               â”‚
â”‚     "customer_data": {...},                                 â”‚
â”‚     "status": "created"                                     â”‚
â”‚   }                                                         â”‚
â”‚ }                                                           â”‚
â”‚ version: 5                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Return checkout_url
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Checkout Component â”‚  redirect($checkout_url)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP 302 Redirect
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer Browser  â”‚  Redirected to CHIP
â”‚                    â”‚  https://gate.chip-in.asia/purchases/pur_abc123
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Customer:
         â”‚ - Sees CHIP payment page
         â”‚ - Selects payment method (FPX, Card, etc.)
         â”‚ - Enters banking credentials
         â”‚ - Completes payment
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHIP Gateway     â”‚  Payment successful!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜




â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WEBHOOK PHASE                                    â”‚
â”‚                    (Payment Successful)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHIP Gateway     â”‚  Sends webhook
â”‚                    â”‚  POST /webhooks/chip
â”‚                    â”‚
â”‚                    â”‚  Payload:
â”‚                    â”‚  {
â”‚                    â”‚    "event": "purchase.paid",
â”‚                    â”‚    "data": {
â”‚                    â”‚      "id": "pur_abc123",
â”‚                    â”‚      "amount": 15000,
â”‚                    â”‚      "status": "paid",
â”‚                    â”‚      "payment": {...}
â”‚                    â”‚    }
â”‚                    â”‚  }
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP POST (signed with RSA)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChipWebhookController   â”‚  handle(Request $request)
â”‚                         â”‚
â”‚  1. Verify signature âœ“  â”‚
â”‚  2. Extract event type  â”‚
â”‚  3. Route to handler    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ event = "purchase.paid"
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChipWebhookController   â”‚  handlePurchasePaid($purchaseData)
â”‚                         â”‚
â”‚  $purchaseId = "pur_abc123"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ handlePaymentSuccess($purchaseId, $webhookData)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CheckoutService        â”‚  Main order creation logic
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Step 1: Check idempotency
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Idempotency Check                                          â”‚
â”‚                                                             â”‚
â”‚  Order::whereHas('payments', function($q) use ($purchaseId) {â”‚
â”‚      $q->where('gateway_payment_id', $purchaseId);         â”‚
â”‚  })->first();                                               â”‚
â”‚                                                             â”‚
â”‚  If found â†’ Return existing order (prevent duplicate)       â”‚
â”‚  If not found â†’ Continue to create order                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Step 2: Find cart by purchase_id
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Find Cart (Database Query)                                 â”‚
â”‚                                                             â”‚
â”‚  SELECT * FROM carts                                        â”‚
â”‚  WHERE metadata::jsonb->'payment_intent'->>'purchase_id'    â”‚
â”‚        = 'pur_abc123';                                      â”‚
â”‚                                                             â”‚
â”‚  Returns: Cart instance with payment intent in metadata     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Step 3: Extract payment intent
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment Intent (from cart metadata)                        â”‚
â”‚                                                             â”‚
â”‚  {                                                          â”‚
â”‚    "purchase_id": "pur_abc123",                             â”‚
â”‚    "amount": 15000,                                         â”‚
â”‚    "cart_snapshot": [                                       â”‚
â”‚      {                                                      â”‚
â”‚        "id": "prod-123",                                    â”‚
â”‚        "name": "Buku Cara Bercinta",                        â”‚
â”‚        "price": 10000,                                      â”‚
â”‚        "quantity": 1,                                       â”‚
â”‚        "attributes": {...}                                  â”‚
â”‚      }                                                      â”‚
â”‚    ],                                                       â”‚
â”‚    "customer_data": {                                       â”‚
â”‚      "email": "customer@example.com",                       â”‚
â”‚      "name": "Ahmad",                                       â”‚
â”‚      "phone": "+60123456789",                               â”‚
â”‚      "street1": "123 Jalan Merdeka",                        â”‚
â”‚      "city": "Kuala Lumpur",                                â”‚
â”‚      "state": "Wilayah Persekutuan",                        â”‚
â”‚      "postcode": "50000",                                   â”‚
â”‚      ...                                                    â”‚
â”‚    },                                                       â”‚
â”‚    "status": "created"                                      â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Step 4: Validate webhook data
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Validation Checks                                          â”‚
â”‚                                                             â”‚
â”‚  âœ“ Purchase ID matches?                                     â”‚
â”‚    intent.purchase_id === webhook.purchase_id               â”‚
â”‚                                                             â”‚
â”‚  âœ“ Amount matches?                                          â”‚
â”‚    intent.amount === webhook.amount                         â”‚
â”‚                                                             â”‚
â”‚  âœ“ Status is "created"?                                     â”‚
â”‚    intent.status === "created"                              â”‚
â”‚                                                             â”‚
â”‚  If all pass â†’ Continue                                     â”‚
â”‚  If any fail â†’ Return null (prevent order creation)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Step 5: Create all database records
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DB::transaction(function() {                   â”‚
â”‚                                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚  A. Create/Find User                            â”‚    â”‚
â”‚    â”‚                                                 â”‚    â”‚
â”‚    â”‚  User::where('email', $email)->first()          â”‚    â”‚
â”‚    â”‚  ?: User::create([                              â”‚    â”‚
â”‚    â”‚      email: customer@example.com,   â† FROM      â”‚    â”‚
â”‚    â”‚      name: Ahmad,                    PAYMENT    â”‚    â”‚
â”‚    â”‚      phone: +60123456789,            INTENT     â”‚    â”‚
â”‚    â”‚      is_guest: true                  customer_  â”‚    â”‚
â”‚    â”‚  ])                                  data       â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                  â”‚                                         â”‚
â”‚                  â–¼                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚  B. Create Address                              â”‚    â”‚
â”‚    â”‚                                                 â”‚    â”‚
â”‚    â”‚  Address::create([                              â”‚    â”‚
â”‚    â”‚      addressable_type: User::class,             â”‚    â”‚
â”‚    â”‚      addressable_id: $user->id,                 â”‚    â”‚
â”‚    â”‚      name: Ahmad,                 â† FROM        â”‚    â”‚
â”‚    â”‚      street1: 123 Jalan Merdeka,   PAYMENT     â”‚    â”‚
â”‚    â”‚      street2: Taman Melati,        INTENT      â”‚    â”‚
â”‚    â”‚      city: Kuala Lumpur,           customer_   â”‚    â”‚
â”‚    â”‚      state: Wilayah Persekutuan,   data        â”‚    â”‚
â”‚    â”‚      postcode: 50000,                           â”‚    â”‚
â”‚    â”‚      phone: +60123456789,                       â”‚    â”‚
â”‚    â”‚      type: billing,                             â”‚    â”‚
â”‚    â”‚      is_primary: true                           â”‚    â”‚
â”‚    â”‚  ])                                             â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                  â”‚                                         â”‚
â”‚                  â–¼                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚  C. Create Order + Order Items                  â”‚    â”‚
â”‚    â”‚                                                 â”‚    â”‚
â”‚    â”‚  Order::create([                                â”‚    â”‚
â”‚    â”‚      order_number: ORD-2025-001,                â”‚    â”‚
â”‚    â”‚      user_id: $user->id,                        â”‚    â”‚
â”‚    â”‚      address_id: $address->id,                  â”‚    â”‚
â”‚    â”‚      cart_items: [...],        â† FROM           â”‚    â”‚
â”‚    â”‚      total: 15000,              PAYMENT         â”‚    â”‚
â”‚    â”‚      status: processing,         INTENT         â”‚    â”‚
â”‚    â”‚      checkout_form_data: {...}   cart_snapshot  â”‚    â”‚
â”‚    â”‚  ])                              & customer_dataâ”‚    â”‚
â”‚    â”‚                                                 â”‚    â”‚
â”‚    â”‚  foreach ($cartSnapshot as $item) {             â”‚    â”‚
â”‚    â”‚      OrderItem::create([                        â”‚    â”‚
â”‚    â”‚          order_id: $order->id,                  â”‚    â”‚
â”‚    â”‚          product_id: $item['id'],               â”‚    â”‚
â”‚    â”‚          quantity: $item['quantity'],           â”‚    â”‚
â”‚    â”‚          unit_price: $item['price']             â”‚    â”‚
â”‚    â”‚      ])                                         â”‚    â”‚
â”‚    â”‚  }                                              â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                  â”‚                                         â”‚
â”‚                  â–¼                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚  D. Create Payment                              â”‚    â”‚
â”‚    â”‚                                                 â”‚    â”‚
â”‚    â”‚  Payment::create([                              â”‚    â”‚
â”‚    â”‚      order_id: $order->id,                      â”‚    â”‚
â”‚    â”‚      gateway_payment_id: pur_abc123, â† FROM    â”‚    â”‚
â”‚    â”‚      gateway_transaction_id: pay_xyz789, WEBHOOKâ”‚    â”‚
â”‚    â”‚      amount: 15000,                      DATA   â”‚    â”‚
â”‚    â”‚      status: completed,                         â”‚    â”‚
â”‚    â”‚      method: fpx_b2c,                           â”‚    â”‚
â”‚    â”‚      currency: MYR,                             â”‚    â”‚
â”‚    â”‚      paid_at: NOW(),                            â”‚    â”‚
â”‚    â”‚      gateway_response: {...full webhook}        â”‚    â”‚
â”‚    â”‚  ])                                             â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚    return $order;                                          â”‚
â”‚                                                             â”‚
â”‚  }) â† Transaction ends                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Transaction committed successfully âœ“
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Clear Cart                                                 â”‚
â”‚                                                             â”‚
â”‚  $cart->clear();                                            â”‚
â”‚                                                             â”‚
â”‚  Removes all items, conditions, and metadata from cart      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Return order
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Final Result                                               â”‚
â”‚                                                             â”‚
â”‚  âœ… users table: 1 new record                               â”‚
â”‚  âœ… addresses table: 1 new record                           â”‚
â”‚  âœ… orders table: 1 new record                              â”‚
â”‚  âœ… order_items table: N new records (one per cart item)    â”‚
â”‚  âœ… payments table: 1 new record                            â”‚
â”‚  âœ… carts table: cart DELETED entirely (clear() method)     â”‚
â”‚                                                             â”‚
â”‚  Order created successfully! ğŸ‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Points Summary

### Phase 1 (Checkout):
```
Customer Input â†’ Form Data
                    â†“
              CHIP API Call
                    â†“
            Store in Cart Metadata
                    â†“
          Redirect to CHIP Gateway
```

**Database Impact:** Only `carts.metadata` updated

---

### Phase 2 (Webhook):
```
CHIP Webhook â†’ Verify Signature
                    â†“
            Find Cart by purchase_id
                    â†“
         Get payment_intent from metadata
                    â†“
            Validate webhook data
                    â†“
           Create ALL records:
           - users
           - addresses
           - orders
           - order_items
           - payments
                    â†“
              Clear cart
```

**Database Impact:** 5+ tables with new records

---

## Data Flow Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer Form   â”‚
â”‚                  â”‚
â”‚  - Name          â”‚
â”‚  - Email         â”‚
â”‚  - Phone         â”‚
â”‚  - Address       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cart Metadata    â”‚
â”‚ payment_intent   â”‚  Stored during checkout
â”‚                  â”‚
â”‚ {                â”‚
â”‚   cart_snapshot, â”‚ â† Cart items at checkout time
â”‚   customer_data, â”‚ â† Form data
â”‚   purchase_id    â”‚ â† CHIP reference
â”‚ }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Retrieved during webhook
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Tables  â”‚
â”‚                  â”‚
â”‚ users â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ customer_data.email, name, phone
â”‚ addresses â†â”€â”€â”€â”€â”€â”€â”¼â”€ customer_data.street1, city, etc.
â”‚ orders â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ cart_snapshot, customer_data, amount
â”‚ order_items â†â”€â”€â”€â”€â”¼â”€ cart_snapshot[*]
â”‚ payments â†â”€â”€â”€â”€â”€â”€â”€â”¼â”€ purchase_id, webhook data
â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Everything flows through cart metadata! It's the single source of truth for order creation.** ğŸ¯
